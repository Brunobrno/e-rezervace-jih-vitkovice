from rest_framework import viewsets, filters
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response

from django_filters.rest_framework import DjangoFilterBackend
from drf_spectacular.utils import extend_schema, OpenApiParameter, OpenApiResponse

from .models import Event, Reservation, MarketSlot, Square
from .serializers import EventSerializer, ReservationSerializer, MarketSlotSerializer, SquareSerializer
from .filters import EventFilter, ReservationFilter

from rest_framework.permissions import IsAuthenticated
from rest_framework.exceptions import PermissionDenied
from django.core.exceptions import ObjectDoesNotExist

from account.permissions import *


@extend_schema(
    tags=["Square"],
    description=(
        "Spr√°va n√°mƒõst√≠ ‚Äì vytvo≈ôen√≠, aktualizace a v√Ωpis s dopl≈àkov√Ωmi informacemi (`quarks`) "
        "a p≈ôipojen√Ωmi eventy. Mo≈æno filtrovat podle mƒõsta, PSƒå a velikosti.\n\n"
        "üîç **Fulltextov√© vyhled√°v√°n√≠ (`?search=`)** prohled√°v√° n√°sleduj√≠c√≠ pole:\n"
        "- n√°zev n√°mƒõst√≠ (`name`)\n"
        "- popis (`description`)\n"
        "- ulice (`street`)\n"
        "- mƒõsto (`city`)\n\n"
        "**P≈ô√≠klady:** `?search=Ostrava`, `?search=Hlavn√≠ t≈ô√≠da`"
    )
)
class SquareViewSet(viewsets.ModelViewSet):
    queryset = Square.objects.prefetch_related("square_events").all().order_by("name")
    serializer_class = SquareSerializer
    filter_backends = [DjangoFilterBackend, filters.OrderingFilter, filters.SearchFilter]
    filterset_fields = ["city", "psc", "width", "height"]
    ordering_fields = ["name", "width", "height"]
    search_fields = [
        "name",         # n√°zev n√°mƒõst√≠
        "description",  # popis
        "street",       # ulice
        "city",         # mƒõsto
        # "psc" je ƒç√≠slo, obvykle do search_fields nepat≈ô√≠, ale m≈Ø≈æe≈° ho filtrovat p≈ôes filterset_fields
    ]

    permission_classes = [RoleAllowed("admin", "squareManager")]


@extend_schema(
    tags=["Event"],
    description=(
        "Z√°kladn√≠ operace pro spr√°vu ud√°lost√≠ (Event). Lze filtrovat podle ƒçasu, mƒõsta a velikosti n√°mƒõst√≠.\n\n"
        "üîç **Fulltextov√© vyhled√°v√°n√≠ (`?search=`)** prohled√°v√°:\n"
        "- n√°zev ud√°losti (`name`)\n"
        "- popis (`description`)\n"
        "- n√°zev n√°mƒõst√≠ (`square.name`)\n"
        "- mƒõsto (`square.city`)\n"
        "- popis n√°mƒõst√≠ (`square.description`)\n"
        "- ulice (`square.street`)\n\n"
        "**P≈ô√≠klady:** `?search=Jarmark`, `?search=Ostrava`, `?search=Masarykovo`"
    )
)
class EventViewSet(viewsets.ModelViewSet):
    queryset = Event.objects.prefetch_related("event_marketSlots", "event_products").all().order_by("start")
    serializer_class = EventSerializer
    filter_backends = [DjangoFilterBackend, filters.OrderingFilter, filters.SearchFilter]
    filterset_class = EventFilter
    ordering_fields = ["start", "end", "price_per_m2"]
    search_fields = [
        "name",                       # n√°zev ud√°losti
        "description",                # popis ud√°losti
        "square__name",              # n√°zev n√°mƒõst√≠
        "square__city",              # mƒõsto
        "square__description",       # popis n√°mƒõst√≠ (voliteln√Ω)
        "square__street",            # ulice
    ]

    permission_classes = [RoleAllowed("admin", "squareManager")]


@extend_schema(
    tags=["MarketSlot"],
    description="Vytv√°≈ôen√≠, aktualizace a maz√°n√≠ konkr√©tn√≠ch prodejn√≠ch m√≠st pro ud√°losti."
)
class MarketSlotViewSet(viewsets.ModelViewSet):
    # queryset = MarketSlot.objects.select_related("event").all().order_by("event")
    queryset = MarketSlot.objects.all().order_by("event")
    serializer_class = MarketSlotSerializer
    filter_backends = [DjangoFilterBackend, filters.OrderingFilter]
    filterset_fields = ["event", "status"]
    ordering_fields = ["price_per_m2", "x", "y"]

    permission_classes = [RoleAllowed("admin", "squareManager")]


@extend_schema(
    tags=["Reservation"],
    description=(
        "Spr√°va rezervac√≠ ‚Äì vytvo≈ôen√≠, √∫prava a v√Ωpis. Filtrov√°n√≠ podle eventu, statusu, u≈æivatele atd.\n\n"
        "üîç **Fulltextov√© vyhled√°v√°n√≠ (`?search=`)** prohled√°v√°:\n"
        "- n√°zev ud√°losti (`event.name`)\n"
        "- n√°zev n√°mƒõst√≠ (`event.square.name`)\n"
        "- mƒõsto (`event.square.city`)\n"
        "- pozn√°mku (`note`)\n"
        "- e-mail u≈æivatele (`user.email`)\n"
        "- jm√©no a p≈ô√≠jmen√≠ u≈æivatele (`user.first_name`, `user.last_name`)\n\n"
        "**P≈ô√≠klady:** `?search=jan.novak@example.com`, `?search=Velikonoƒçn√≠`, `?search=Ostrava`"
    )
)
class ReservationViewSet(viewsets.ModelViewSet):
    # queryset = Reservation.objects.select_related("event", "marketSlot", "user").all().order_by("-created_at")
    queryset = Reservation.objects.all().order_by("-created_at")
    serializer_class = ReservationSerializer
    filter_backends = [DjangoFilterBackend, filters.OrderingFilter]
    filterset_class = ReservationFilter
    ordering_fields = ["reserved_from", "reserved_to", "created_at"]
    search_fields = [
        "event__name",
        "event__square__name",
        "event__square__city",
        "note",
        "user__email",
        "user__first_name",
        "user__last_name",
    ]
    permission_classes = [RoleAllowed("admin", "squareManager", "seller")]

    def get_queryset(self):
        # queryset = Reservation.objects.select_related("event", "marketSlot", "user").prefetch_related("event_products").order_by("-created_at")
        queryset = Reservation.objects.all().order_by("-created_at")
        user = self.request.user
        if hasattr(user, "role") and user.role == "seller":
            return queryset.filter(user=user)
        return queryset
    
    def perform_create(self, serializer):
        self._check_blocked_permission(serializer.validated_data)
        serializer.save()

    def perform_update(self, serializer):
        self._check_blocked_permission(serializer.validated_data)
        serializer.save()

    def _check_blocked_permission(self, data):
        slot_id = data.get("marketSlot")

        if not isinstance(slot_id, int):
            raise PermissionDenied("Neplatn√© ID prodejn√≠ho m√≠sta.")

        try:
            market_slot = MarketSlot.objects.get(pk=slot_id)
        except ObjectDoesNotExist:
            raise PermissionDenied("Prodejn√≠ m√≠sto nebylo nalezeno.")

        if market_slot.status == "blocked":
            user = self.request.user
            if getattr(user, "role", None) not in ["admin", "clerk"]:
                raise PermissionDenied("Toto prodejn√≠ m√≠sto je zablokovan√©.")
